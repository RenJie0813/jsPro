"use strict";var bgID;$(function(){function e(e,a){if(bgID=e,2==a&&-1!=e||-1==e&&!a)$(".modal .title").html("添加BG"),$(".sub").html("确认添加"),2==a&&(sendRequest("bg.getInfo",[parseInt(e)],function(e){0==e.code?f(e.data,"edit"):console.log(e)}),bgID=-1);else{if(1!=a){if($("#addLine").unbind("click").on("click",function(){if("none"!=$(".insert_a").css("display")||"none"!=$(".insert_p").css("display"))return void alert("请先完成当前添加！");2==a?($(".insert_p").hide(),$(".insert_a").show(),$(".addBtn").unbind("click").on("click",function(){d(1)})):($(".insert_a").hide(),$(".insert_p").show(),$(".addBtn").unbind("click").on("click",function(){d(2)}))}),2==a){if($("#editDiv .addTitle p").text("AgentServers Manage"),h.agentServers&&Array.isArray(h.agentServers)){for(var i=h.agentServers,o="",r=0,c=i.length;r<c;r++)o+="<div class='agent' ip='"+i[r]+"'><p>"+i[r]+"</p><p><i class='delete'>删除</i></p></div>";$(o).insertBefore("#editDiv div.insert")}l(),t()}else $("#editDiv .addTitle p").text("GameServers Manage"),!!h.gameServers&&Array.isArray(h.gameServers)&&(b=h.gameServers),s(t);return $("#editDiv .sub-add input[type='button']").attr("id",e),$("#editDiv .sub-add input[type='button']").attr("data-t",a),void $("#editDiv .sub-add input[type='button']").unbind("click").on("click",function(){$(".load").show();var e=$(this).attr("id"),t=$(this).attr("data-t"),a=[];if(2==t)for(var i=$("div.agent"),o=0,d=i.length;o<d;o++)a.push($(i[o]).attr("ip"));else for(var r=$("div.game"),o=0,d=r.length;o<d;o++)a.push({ip:$(r[o]).attr("ip"),num:parseInt($(r[o]).attr("num")),gid:$(r[o]).attr("name")});sendRequest(2==t?"bg.changeAerver":"bg.changeGerver",[parseInt(e),a],function(e){0==e.code?($(".load .wait").hide(),$(".load .suc").show(),a=[],2==t?l():s(),setTimeout(n,1600)):console.log(e)})})}$(".modal .title").html("BG信息修改"),$(".sub").html("确认修改"),!!h&&f(h,"edit")}$(".sub").unbind("click").on("click",function(e){e.preventDefault(),e.stopPropagation();var t=bgID,a=$("#name").val(),i=$("#version").val(),o=$("#domain").val(),s=$("#dbServer").val(),l=$("#logDBServer").val(),d=$("#codeStatus").val(),r=$("#sslKey").val(),c=$("#sslCrt").val();if(a&&i&&s&&o&&l&&d&&c&&r){var v={status:0,name:a,version:parseInt(i),domain:o,dbServer:s,logDBServer:l,agentServers:[],gameServers:[],codeStatus:parseInt(d),sslCrt:c,sslKey:r};if(-1!=o.indexOf(",")){var p=$("#sslCrt1").val(),u=$("#sslKey1").val();if(!p||!u)return void alert("请填写完全部数据再提交！");v.sslCrt1=p,v.sslKey1=u}$(".load").show(),-1==t?sendRequest("bg.add",[v],function(e){0==e.code?($(".load .wait").hide(),$(".load .suc").show(),setTimeout(n,1600)):console.log(e)}):sendRequest("bg.upBase",[t,v],function(e){0==e.code?($(".load .wait").hide(),$(".load .suc").show(),setTimeout(n,1600)):console.log(e)})}else alert("请填写完全部数据再提交！")}),u()}function t(){u(),$("#editDiv").show(),$("#editDiv").on("click","i.delete",function(){$(this).parent().parent().remove()}),$(".top-edit").on("click",function(){n()})}function n(){$(".load").hide(),$(".load .wait").show(),$(".load .suc").hide(),$("#editDiv").hide(),$(".insert_a").hide(),$(".insert_p").hide(),$("#num").val("0"),$(".game").remove(),$(".agent").remove(),$("textarea").val(""),$(".background").hide(),$(".modal").removeClass("bounceInDown"),$("select").val("");for(var e=document.getElementsByName("agentServers"),t=0,n=e.length;t<n;t++)e[t].checked=!1;$("input[type='text']").val(""),$("select").next("span").text("————请选择————")}function a(){i(),o(),S=1}function i(){c("server.getList",[0],"#dbServer","获取db列表错误！")}function o(){c("server.getList",[2],"#logDBServer","获取logDB列表错误！")}function s(e){c("server.getList",[3],"#gameIpSelect","获取gameServerIP列表错误！"),sendRequest("pm.getGameList",[],function(t){if("[object Object]"==Object.prototype.toString.call(t)){var n="";for(var a in t)n+=v(t[a].ID,t[a].CName);n="<option value=''>请选择</option>"+n,$("#gameSelect").empty().append(n),r(b),!!e&&e()}else alert("获取游戏列表错误！"),console.log(t)})}function l(){c("server.getList",[4],"#agentIpSelect","获取agent列表错误！")}function d(e){var t="";if(1==e){var n=$("#agentIpSelect").val();if(!n)return;0==$("div[ip='"+n+"']").length?t+="<div class='agent' ip='"+n+"'><p>"+n+"</p><p><i class='delete'>删除</i></p></div>":alert("请勿添加重复项！")}else{var a=$("#gameIpSelect").val(),i=$("#num").val(),o=$("#gameSelect").val(),s=document.getElementById("gameSelect"),l=s[s.selectedIndex].text;if(!(a&&o&&i))return;0==$("div[ip='"+a+"'][name='"+o+"']").length?t+="<div class='game' num='"+i+"' ip='"+a+"' name='"+o+"'><p>"+a+"</p><p>"+i+"</p><p>"+l+"</p><p><i class='delete'>删除</i></p></div>":alert("请勿添加重复项！")}$(t).insertBefore("#editDiv div.insert"),$(".insert_a,.insert_p").hide(),$("#agentIp,#game,#gameIp").text("————请选择————"),$("#num").val("0"),$("#editDiv select").val("")}function r(e){$(".game").remove();var t=e.length;if(t>0){for(var n="",a=0;a<t;a++){var i=$("#gameSelect").children("option[value='"+e[a].gid+"']").text();n+="<div class='game' num='"+e[a].num+"' ip='"+e[a].ip+"' name='"+e[a].gid+"'><p>"+e[a].ip+"</p><p>"+e[a].num+"</p><p>"+i+"</p><p><i class='delete'>删除</i></p></div>"}$(n).insertBefore("#editDiv div.insert")}}function c(e,t,n,a,i){sendRequest(e,t,function(t){if(0==t.code){for(var o=t.data,s="",l=0,d=o.length;l<d;l++)"ver.getList"==e?s+=v(o[l].id,o[l].name):"#agentIpSelect"==n||"#gameIpSelect"==n?(!o[l].usedByBG||-1==o[l].usedByBG||o[l].usedByBG==bgID)&&(s+=v(o[l].ip,o[l].ip)):s+=v(o[l].ip,o[l].ip);s&&("#agentIpSelect"==n?($("#agentIpSelect").empty(),s="<option value=''>请选择</option>"+s):"#gameIpSelect"==n&&($("#gameIpSelect").empty(),s="<option value=''>请选择</option>"+s),$(n).append(s)),!!i&&"[object Function]"==Object.prototype.toString.call(i)&&i()}else alert(a),console.log(t)})}function v(e,t){return"<option value='"+e+"'>"+t+"</option>"}function p(e){for(var t="",n=0,a=e.length;n<a;n++){var i=e[n],o="<tr><td class='on'>"+i.name+"</td><td>"+i.index+"</td><td class='on'>"+$("#version").children("option[value='"+i.version+"']").text()+"</td><td>"+i.domain+"</td><td>"+i.status+"</td><td>";switch(i.codeStatus){case"0":o+="研发中";break;case"1":o+="测试";break;case"2":o+="正式";break;default:o+="未填写"}o+="</td><td class='on' id='"+i.index+"'><span class='edit trans' type='1'>基础</span><span class='edit trans' type='2'>代理服</span><span class='edit trans' type='3'>游戏服</span></td></tr>",t+=o}$(".datalist>table tbody").empty().append(t)}function u(){$(".background").show(),$(".modal").addClass("bounceInDown")}function g(e){e?($("#viewData,#formData").hide(),$("#editDiv").show()):($("#viewData").hide(),$("#formData").show())}function m(e,t){for(var n=document.getElementById(e),a=0;a<n.options.length;a++)if(n.options[a].value==t)return $("#"+e).val(t),void $("#"+e).next("span").text(t);$("#"+e).next("span").text("————请选择————")}function f(e,t){if("[object Object]"==Object.prototype.toString.call(e))if("edit"==t){$("#name").val(e.name),$("#version").val(e.version);var n=document.getElementById("version");$("#version").next("span").text(n[n.selectedIndex].text),$("#domain").val(e.domain),m("dbServer",e.dbServer),m("logDBServer",e.logDBServer),$("#codeStatus").val(e.codeStatus);var a=document.getElementById("codeStatus");$("#codeStatus").next("span").text(a[a.selectedIndex].text),$("#sslCrt").val(e.sslCrt),$("#sslKey").val(e.sslKey),e.domain.indexOf(",")>0?($(".two").show(),$("#sslCrt1").val(e.sslCrt1),$("#sslKey1").val(e.sslKey1)):$(".two").hide(),h=null}else $("#v-sslCrt").val(e.sslCrt),$("#v-sslKey").val(e.sslKey),$("#v-name").val(e.name),$("#v-index").val(e.index),$("#v-version").val($("#version").children("option[value='"+e.version+"']").text()),$("#v-domain").val(e.domain),$("#v-dbServer").val(e.dbServer),$("#v-log").val(e.logDBServer),$("#v-codeStatus").val($("#codeStatus").children("option[value='"+e.codeStatus+"']").text()),e.domain.indexOf(",")>0?$(".show-two").show():$(".show-two").hide();else alert("Data不是一个对象！初始化数据为空！")}var h=null,b=[],S=0;a(),c("ver.getList",[],"#version","获取版本列表错误！",function(){sendRequest("bg.getList",[],function(e){0==e.code?p(e.data):console.log(e)})}),$("#domain").on("blur",function(){$("#domain").val().indexOf(",")>-1?$(".two").show():$(".two").hide()}),$("select").on("change",function(){var e=$(this).get(0);$(this).next().html(e.options[e.options.selectedIndex].text)}),$("#add").on("click",function(t){t.stopPropagation(),0==S&&a(),g(),e(-1)}),$(".datalist>table").on("click","span.edit",function(t){t.stopPropagation();var n=$(this).parent().attr("id"),i=$(this).attr("type");g(i),n?2==i?(g(),e(n,i)):(0==S&&1==i&&a(),sendRequest("bg.getInfo",[parseInt(n)],function(t){0==t.code?(h=t.data,e(n,i)):console.log(t)})):alert("id或标识列为空！请查看编辑列是否存在id属性")}),$(".datalist>table").on("click","td",function(e){if("SPAN"!=e.target.nodeName){var t=$(this).parent().children("td:last-child").attr("id");t?($(".modal .title").html("BG详细信息"),$("#formData").hide(),$("#viewData").show(),$(".ed").attr("id",t),sendRequest("bg.getInfo",[parseInt(t)],function(e){0==e.code?(h=e.data,f(h,"select"),u()):console.log(e)})):alert("id或标识列为空！请查看编辑列是否存在id属性")}}),$(".close").on("click",n),$(".ed").on("click",function(t){var n=$(t.target).attr("id");t.preventDefault(),t.stopPropagation(),n?(0==S&&a(),g(),e(n,1)):alert("id或标识列为空！请查看编辑列是否存在id属性")})});